49be89280d115184e9a936c3ea62d0d6
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@angular/core/testing");
const testing_2 = require("@angular/common/http/testing");
const auth_jwt_service_1 = require("app/core/auth/auth-jwt.service");
const ngx_webstorage_1 = require("ngx-webstorage");
describe('Auth JWT', () => {
    let service;
    let localStorageService;
    let sessionStorageService;
    let httpMock;
    beforeEach(() => {
        testing_1.TestBed.configureTestingModule({
            imports: [testing_2.HttpClientTestingModule, ngx_webstorage_1.NgxWebstorageModule.forRoot()],
        });
        httpMock = testing_1.TestBed.inject(testing_2.HttpTestingController);
        service = testing_1.TestBed.inject(auth_jwt_service_1.AuthServerProvider);
        localStorageService = testing_1.TestBed.inject(ngx_webstorage_1.LocalStorageService);
        sessionStorageService = testing_1.TestBed.inject(ngx_webstorage_1.SessionStorageService);
    });
    describe('Get Token', () => {
        it('should return empty token if not found in local storage nor session storage', () => {
            const result = service.getToken();
            expect(result).toEqual('');
        });
        it('should return token from session storage if local storage is empty', () => {
            sessionStorageService.retrieve = jest.fn().mockReturnValue('sessionStorageToken');
            const result = service.getToken();
            expect(result).toEqual('sessionStorageToken');
        });
        it('should return token from localstorage storage', () => {
            localStorageService.retrieve = jest.fn().mockReturnValue('localStorageToken');
            const result = service.getToken();
            expect(result).toEqual('localStorageToken');
        });
    });
    describe('Login', () => {
        it('should clear session storage and save in local storage when rememberMe is true', () => {
            // GIVEN
            localStorageService.store = jest.fn();
            sessionStorageService.clear = jest.fn();
            // WHEN
            service.login({ username: 'John', password: '123', rememberMe: true }).subscribe();
            httpMock.expectOne('api/authenticate').flush({ id_token: '1' });
            // THEN
            httpMock.verify();
            expect(localStorageService.store).toHaveBeenCalledWith('authenticationToken', '1');
            expect(sessionStorageService.clear).toHaveBeenCalled();
        });
        it('should clear local storage and save in session storage when rememberMe is false', () => {
            // GIVEN
            sessionStorageService.store = jest.fn();
            localStorageService.clear = jest.fn();
            // WHEN
            service.login({ username: 'John', password: '123', rememberMe: false }).subscribe();
            httpMock.expectOne('api/authenticate').flush({ id_token: '1' });
            // THEN
            httpMock.verify();
            expect(sessionStorageService.store).toHaveBeenCalledWith('authenticationToken', '1');
            expect(localStorageService.clear).toHaveBeenCalled();
        });
    });
    describe('Logout', () => {
        it('should clear storage', () => {
            // GIVEN
            sessionStorageService.clear = jest.fn();
            localStorageService.clear = jest.fn();
            // WHEN
            service.logout().subscribe();
            // THEN
            expect(localStorageService.clear).toHaveBeenCalled();
            expect(sessionStorageService.clear).toHaveBeenCalled();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUva2FydGhpay9jeW5hcHNlVGVjaC9zcmMvbWFpbi93ZWJhcHAvYXBwL2NvcmUvYXV0aC9hdXRoLWp3dC5zZXJ2aWNlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSxtREFBZ0Q7QUFDaEQsMERBQThGO0FBQzlGLHFFQUFvRTtBQUNwRSxtREFBaUc7QUFFakcsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7SUFDeEIsSUFBSSxPQUEyQixDQUFDO0lBQ2hDLElBQUksbUJBQXdDLENBQUM7SUFDN0MsSUFBSSxxQkFBNEMsQ0FBQztJQUNqRCxJQUFJLFFBQStCLENBQUM7SUFFcEMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLGlCQUFPLENBQUMsc0JBQXNCLENBQUM7WUFDN0IsT0FBTyxFQUFFLENBQUMsaUNBQXVCLEVBQUUsb0NBQW1CLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDbEUsQ0FBQyxDQUFDO1FBRUgsUUFBUSxHQUFHLGlCQUFPLENBQUMsTUFBTSxDQUFDLCtCQUFxQixDQUFDLENBQUM7UUFDakQsT0FBTyxHQUFHLGlCQUFPLENBQUMsTUFBTSxDQUFDLHFDQUFrQixDQUFDLENBQUM7UUFDN0MsbUJBQW1CLEdBQUcsaUJBQU8sQ0FBQyxNQUFNLENBQUMsb0NBQW1CLENBQUMsQ0FBQztRQUMxRCxxQkFBcUIsR0FBRyxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxzQ0FBcUIsQ0FBQyxDQUFDO0lBQ2hFLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7UUFDekIsRUFBRSxDQUFDLDZFQUE2RSxFQUFFLEdBQUcsRUFBRTtZQUNyRixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDbEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxvRUFBb0UsRUFBRSxHQUFHLEVBQUU7WUFDNUUscUJBQXFCLENB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QUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFFdEMsT0FBTztZQUNQLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUU3QixPQUFPO1lBQ1AsTUFBTSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDckQsTUFBTSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDekQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2thcnRoaWsvY3luYXBzZVRlY2gvc3JjL21haW4vd2ViYXBwL2FwcC9jb3JlL2F1dGgvYXV0aC1qd3Quc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3RCZWQgfSBmcm9tICdAYW5ndWxhci9jb3JlL3Rlc3RpbmcnO1xuaW1wb3J0IHsgSHR0cENsaWVudFRlc3RpbmdNb2R1bGUsIEh0dHBUZXN0aW5nQ29udHJvbGxlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwL3Rlc3RpbmcnO1xuaW1wb3J0IHsgQXV0aFNlcnZlclByb3ZpZGVyIH0gZnJvbSAnYXBwL2NvcmUvYXV0aC9hdXRoLWp3dC5zZXJ2aWNlJztcbmltcG9ydCB7IExvY2FsU3RvcmFnZVNlcnZpY2UsIE5neFdlYnN0b3JhZ2VNb2R1bGUsIFNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJ25neC13ZWJzdG9yYWdlJztcblxuZGVzY3JpYmUoJ0F1dGggSldUJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogQXV0aFNlcnZlclByb3ZpZGVyO1xuICBsZXQgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZTtcbiAgbGV0IHNlc3Npb25TdG9yYWdlU2VydmljZTogU2Vzc2lvblN0b3JhZ2VTZXJ2aWNlO1xuICBsZXQgaHR0cE1vY2s6IEh0dHBUZXN0aW5nQ29udHJvbGxlcjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBUZXN0QmVkLmNvbmZpZ3VyZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgaW1wb3J0czogW0h0dHBDbGllbnRUZXN0aW5nTW9kdWxlLCBOZ3hXZWJzdG9yYWdlTW9kdWxlLmZvclJvb3QoKV0sXG4gICAgfSk7XG5cbiAgICBodHRwTW9jayA9IFRlc3RCZWQuaW5qZWN0KEh0dHBUZXN0aW5nQ29udHJvbGxlcik7XG4gICAgc2VydmljZSA9IFRlc3RCZWQuaW5qZWN0KEF1dGhTZXJ2ZXJQcm92aWRlcik7XG4gICAgbG9jYWxTdG9yYWdlU2VydmljZSA9IFRlc3RCZWQuaW5qZWN0KExvY2FsU3RvcmFnZVNlcnZpY2UpO1xuICAgIHNlc3Npb25TdG9yYWdlU2VydmljZSA9IFRlc3RCZWQuaW5qZWN0KFNlc3Npb25TdG9yYWdlU2VydmljZSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdHZXQgVG9rZW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZW1wdHkgdG9rZW4gaWYgbm90IGZvdW5kIGluIGxvY2FsIHN0b3JhZ2Ugbm9yIHNlc3Npb24gc3RvcmFnZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UuZ2V0VG9rZW4oKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoJycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdG9rZW4gZnJvbSBzZXNzaW9uIHN0b3JhZ2UgaWYgbG9jYWwgc3RvcmFnZSBpcyBlbXB0eScsICgpID0+IHtcbiAgICAgIHNlc3Npb25TdG9yYWdlU2VydmljZS5yZXRyaWV2ZSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJ3Nlc3Npb25TdG9yYWdlVG9rZW4nKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UuZ2V0VG9rZW4oKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoJ3Nlc3Npb25TdG9yYWdlVG9rZW4nKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRva2VuIGZyb20gbG9jYWxzdG9yYWdlIHN0b3JhZ2UnLCAoKSA9PiB7XG4gICAgICBsb2NhbFN0b3JhZ2VTZXJ2aWNlLnJldHJpZXZlID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSgnbG9jYWxTdG9yYWdlVG9rZW4nKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2UuZ2V0VG9rZW4oKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoJ2xvY2FsU3RvcmFnZVRva2VuJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdMb2dpbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNsZWFyIHNlc3Npb24gc3RvcmFnZSBhbmQgc2F2ZSBpbiBsb2NhbCBzdG9yYWdlIHdoZW4gcmVtZW1iZXJNZSBpcyB0cnVlJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIGxvY2FsU3RvcmFnZVNlcnZpY2Uuc3RvcmUgPSBqZXN0LmZuKCk7XG4gICAgICBzZXNzaW9uU3RvcmFnZVNlcnZpY2UuY2xlYXIgPSBqZXN0LmZuKCk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIHNlcnZpY2UubG9naW4oeyB1c2VybmFtZTogJ0pvaG4nLCBwYXNzd29yZDogJzEyMycsIHJlbWVtYmVyTWU6IHRydWUgfSkuc3Vic2NyaWJlKCk7XG4gICAgICBodHRwTW9jay5leHBlY3RPbmUoJ2FwaS9hdXRoZW50aWNhdGUnKS5mbHVzaCh7IGlkX3Rva2VuOiAnMScgfSk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGh0dHBNb2NrLnZlcmlmeSgpO1xuICAgICAgZXhwZWN0KGxvY2FsU3RvcmFnZVNlcnZpY2Uuc3RvcmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdhdXRoZW50aWNhdGlvblRva2VuJywgJzEnKTtcbiAgICAgIGV4cGVjdChzZXNzaW9uU3RvcmFnZVNlcnZpY2UuY2xlYXIpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY2xlYXIgbG9jYWwgc3RvcmFnZSBhbmQgc2F2ZSBpbiBzZXNzaW9uIHN0b3JhZ2Ugd2hlbiByZW1lbWJlck1lIGlzIGZhbHNlJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIHNlc3Npb25TdG9yYWdlU2VydmljZS5zdG9yZSA9IGplc3QuZm4oKTtcbiAgICAgIGxvY2FsU3RvcmFnZVNlcnZpY2UuY2xlYXIgPSBqZXN0LmZuKCk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIHNlcnZpY2UubG9naW4oeyB1c2VybmFtZTogJ0pvaG4nLCBwYXNzd29yZDogJzEyMycsIHJlbWVtYmVyTWU6IGZhbHNlIH0pLnN1YnNjcmliZSgpO1xuICAgICAgaHR0cE1vY2suZXhwZWN0T25lKCdhcGkvYXV0aGVudGljYXRlJykuZmx1c2goeyBpZF90b2tlbjogJzEnIH0pO1xuXG4gICAgICAvLyBUSEVOXG4gICAgICBodHRwTW9jay52ZXJpZnkoKTtcbiAgICAgIGV4cGVjdChzZXNzaW9uU3RvcmFnZVNlcnZpY2Uuc3RvcmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdhdXRoZW50aWNhdGlvblRva2VuJywgJzEnKTtcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2VTZXJ2aWNlLmNsZWFyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdMb2dvdXQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjbGVhciBzdG9yYWdlJywgKCkgPT4ge1xuICAgICAgLy8gR0lWRU5cbiAgICAgIHNlc3Npb25TdG9yYWdlU2VydmljZS5jbGVhciA9IGplc3QuZm4oKTtcbiAgICAgIGxvY2FsU3RvcmFnZVNlcnZpY2UuY2xlYXIgPSBqZXN0LmZuKCk7XG5cbiAgICAgIC8vIFdIRU5cbiAgICAgIHNlcnZpY2UubG9nb3V0KCkuc3Vic2NyaWJlKCk7XG5cbiAgICAgIC8vIFRIRU5cbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2VTZXJ2aWNlLmNsZWFyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3Qoc2Vzc2lvblN0b3JhZ2VTZXJ2aWNlLmNsZWFyKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=